name: éªŒè¯GitHub Token

on:
    workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘æµ‹è¯•

jobs:
    test-token:
      runs-on: ubuntu-latest

      steps:
      - name: éªŒè¯GitHub Token
        run: |
          echo "æ­£åœ¨éªŒè¯GitHub Token..."

          # éªŒè¯Gistè®¿é—®æƒé™
          response=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.PUSH_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/gists/${{ secrets.GIST_ID }}")

          if [ "$response" -ne 200 ]; then
            echo "âŒ TokenéªŒè¯å¤±è´¥ï¼ŒHTTPçŠ¶æ€ç : $response"
            echo "è¯·æ£€æŸ¥ï¼š"
            echo "1. PUSH_TOKEN æ˜¯å¦æœ‰æ•ˆä¸”æœªè¿‡æœŸ"
            echo "2. GIST_ID æ˜¯å¦æ­£ç¡®"
            echo "3. Token æ˜¯å¦å…·æœ‰ gist æƒé™"
            exit 1
          fi

          # éªŒè¯Gistå†…å®¹
          echo "âœ… TokenéªŒè¯æˆåŠŸï¼Œæ­£åœ¨éªŒè¯Gistå†…å®¹..."
          gist_content=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.PUSH_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/gists/${{ secrets.GIST_ID }}")

          # æ£€æŸ¥Gistæ˜¯å¦åŒ…å«é¢„æœŸçš„æ–‡ä»¶
          if echo "$gist_content" | grep -q '"filename"'; then
            echo "âœ… Gistå†…å®¹éªŒè¯æˆåŠŸ"
            echo "ğŸ“‹ GiståŒ…å«çš„æ–‡ä»¶ï¼š"
            echo "$gist_content" | grep -o '"filename":"[^"]*"' | sed 's/"filename":"\(.*\)"/  - \1/'
          else
            echo "âš ï¸  Gistä¸­æœªæ‰¾åˆ°æ–‡ä»¶ï¼Œè¯·ç¡®ä¿Gistå·²æ­£ç¡®åˆ›å»º"
          fi
