name: éªŒè¯GitHub Tokenå¹¶åˆ›å»ºGist

on:
    workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘æµ‹è¯•

jobs:
    test-token:
      runs-on: ubuntu-latest

      steps:
      - name: éªŒè¯GitHub Token
        run: |
          echo "æ­£åœ¨éªŒè¯GitHub Token..."

          # éªŒè¯TokenåŸºæœ¬æƒé™
          user_info=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.PUSH_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/user")

          if echo "$user_info" | grep -q '"login"'; then
            echo "âœ… TokenéªŒè¯æˆåŠŸ"
            username=$(echo "$user_info" | grep -o '"login":"[^"]*"' | sed 's/"login":"\(.*\)"/\1/')
            echo "ğŸ‘¤ ç”¨æˆ·å: $username"
          else
            echo "âŒ TokenéªŒè¯å¤±è´¥"
            echo "è¯·æ£€æŸ¥PUSH_TOKENæ˜¯å¦æœ‰æ•ˆä¸”å…·æœ‰é€‚å½“çš„æƒé™"
            exit 1
          fi

          # æ£€æŸ¥Gistæ˜¯å¦å­˜åœ¨
          echo "ğŸ” æ£€æŸ¥Gistæ˜¯å¦å­˜åœ¨..."
          gist_response=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.PUSH_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/gists/${{ secrets.GIST_ID }}")

          if echo "$gist_response" | grep -q '"id"'; then
            echo "âœ… Gistå­˜åœ¨ä¸”å¯è®¿é—®"
            echo "ğŸ“‹ Gistæè¿°: $(echo "$gist_response" | grep -o '"description":"[^"]*"' | sed
  's/"description":"\(.*\)"/\1/')"
            echo "ğŸ“ Gistæ–‡ä»¶:"
            echo "$gist_response" | grep -o '"filename":"[^"]*"' | sed 's/"filename":"\(.*\)"/  - \1/'
          else
            echo "âš ï¸  Gistä¸å­˜åœ¨æˆ–æ— æƒè®¿é—®"
            echo "ğŸ“ æ­£åœ¨åˆ›å»ºæ–°çš„æµ‹è¯•Gist..."

            # åˆ›å»ºæ–°çš„Gist
            new_gist=$(curl -s \
              -X POST \
              -H "Authorization: Bearer ${{ secrets.PUSH_TOKEN }}" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              -d '{
                "description": "æµ‹è¯•Gist - ä»£ç†èšåˆå™¨é…ç½®",
                "public": false,
                "files": {
                  "test.txt": {
                    "content": "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶ï¼Œç”¨äºéªŒè¯GitHub Tokenæƒé™\nåˆ›å»ºæ—¶é—´: '"$(date -u)"'"
                  },
                  "config.json": {
                    "content": "{
    \"test\": true,
    \"created_at\": \"'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'\",
    \"message\": \"ä»£ç†èšåˆå™¨æµ‹è¯•é…ç½®\"
  }"
                  }
                }
              }' \
              "https://api.github.com/gists")

            if echo "$new_gist" | grep -q '"id"'; then
              new_gist_id=$(echo "$new_gist" | grep -o '"id":"[^"]*"' | sed 's/"id":"\(.*\)"/\1/')
              echo "âœ… æ–°Giståˆ›å»ºæˆåŠŸ!"
              echo "ğŸ”— Gist ID: $new_gist_id"
              echo "ğŸ“ è¯·æ›´æ–°ä½ çš„ä»“åº“secretsä¸­çš„GIST_IDä¸º: $new_gist_id"
              echo "ğŸ”— Gist URL: https://gist.github.com/$username/$new_gist_id"
            else
              echo "âŒ Giståˆ›å»ºå¤±è´¥"
              echo "é”™è¯¯ä¿¡æ¯: $new_gist"
              exit 1
            fi
          fi
